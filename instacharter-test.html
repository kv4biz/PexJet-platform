<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InstaCharter Empty Legs Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        color: #fff;
      }

      .header {
        background: rgba(0, 0, 0, 0.3);
        padding: 20px 40px;
        border-bottom: 1px solid rgba(212, 175, 55, 0.3);
      }

      .header h1 {
        color: #d4af37;
        font-size: 24px;
        font-weight: 600;
      }

      .header p {
        color: #888;
        font-size: 14px;
        margin-top: 4px;
      }

      .container {
        display: flex;
        height: calc(100vh - 80px);
      }

      .deals-panel {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
      }

      .detail-panel {
        width: 450px;
        padding: 20px;
        background: rgba(0, 0, 0, 0.2);
        overflow-y: auto;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .btn {
        background: #d4af37;
        color: #000;
        border: none;
        padding: 10px 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn:hover {
        background: #e5c158;
      }

      .btn:disabled {
        background: #555;
        color: #888;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: transparent;
        border: 1px solid #d4af37;
        color: #d4af37;
      }

      .btn-secondary:hover {
        background: rgba(212, 175, 55, 0.1);
      }

      .deals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 16px;
      }

      .deal-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .deal-card:hover {
        border-color: #d4af37;
        background: rgba(212, 175, 55, 0.05);
      }

      .deal-card.selected {
        border-color: #d4af37;
        background: rgba(212, 175, 55, 0.1);
      }

      .deal-route {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .deal-city {
        flex: 1;
      }

      .deal-city-name {
        font-weight: 600;
        font-size: 16px;
      }

      .deal-icao {
        color: #d4af37;
        font-size: 12px;
        font-family: monospace;
      }

      .deal-arrow {
        color: #d4af37;
        font-size: 20px;
      }

      .deal-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 13px;
        color: #aaa;
      }

      .deal-info-item {
        display: flex;
        flex-direction: column;
      }

      .deal-info-label {
        font-size: 10px;
        text-transform: uppercase;
        color: #666;
      }

      .deal-info-value {
        color: #fff;
      }

      .deal-price {
        color: #4ade80;
        font-weight: 600;
      }

      .detail-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #666;
        text-align: center;
      }

      .detail-empty svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
      }

      .detail-header {
        margin-bottom: 20px;
      }

      .detail-header h2 {
        color: #d4af37;
        font-size: 18px;
        margin-bottom: 4px;
      }

      .detail-header p {
        color: #888;
        font-size: 13px;
      }

      .aircraft-image-container {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .aircraft-image-container img {
        max-width: 100%;
        max-height: 250px;
        object-fit: contain;
      }

      .aircraft-image-container .loading {
        color: #666;
      }

      .aircraft-image-container .no-image {
        color: #666;
        text-align: center;
        padding: 20px;
      }

      .detail-section {
        margin-bottom: 20px;
      }

      .detail-section-title {
        font-size: 12px;
        text-transform: uppercase;
        color: #666;
        margin-bottom: 8px;
        letter-spacing: 1px;
      }

      .detail-route {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: rgba(0, 0, 0, 0.2);
      }

      .detail-route-city {
        flex: 1;
        text-align: center;
      }

      .detail-route-city-name {
        font-size: 18px;
        font-weight: 600;
      }

      .detail-route-icao {
        color: #d4af37;
        font-family: monospace;
      }

      .detail-route-date {
        font-size: 12px;
        color: #888;
        margin-top: 4px;
      }

      .detail-specs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .detail-spec {
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
      }

      .detail-spec-label {
        font-size: 10px;
        text-transform: uppercase;
        color: #666;
      }

      .detail-spec-value {
        font-size: 16px;
        font-weight: 600;
        margin-top: 4px;
      }

      .detail-spec-value.price {
        color: #4ade80;
      }

      .operator-info {
        padding: 16px;
        background: rgba(0, 0, 0, 0.2);
      }

      .operator-name {
        font-weight: 600;
        margin-bottom: 8px;
      }

      .operator-contact {
        font-size: 13px;
        color: #888;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .loading-overlay.hidden {
        display: none;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: #d4af37;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .status-bar {
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.3);
        font-size: 12px;
        color: #888;
        display: flex;
        justify-content: space-between;
      }

      .page-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* Search & Filter Styles */
      .search-filter-panel {
        background: rgba(0, 0, 0, 0.3);
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .search-row {
        display: flex;
        gap: 16px;
        align-items: flex-end;
        flex-wrap: wrap;
      }

      .search-group {
        flex: 1;
        min-width: 200px;
        position: relative;
      }

      .search-label {
        display: block;
        font-size: 10px;
        text-transform: uppercase;
        color: #888;
        margin-bottom: 6px;
        letter-spacing: 1px;
      }

      .search-input-wrapper {
        position: relative;
      }

      .search-input {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        transition: all 0.2s;
      }

      .search-input:focus {
        border-color: #d4af37;
        background: rgba(212, 175, 55, 0.05);
      }

      .search-input::placeholder {
        color: #666;
      }

      .search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #1a1a2e;
        border: 1px solid rgba(212, 175, 55, 0.3);
        max-height: 300px;
        overflow-y: auto;
        z-index: 50;
        display: none;
      }

      .search-dropdown.active {
        display: block;
      }

      .search-dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.15s;
      }

      .search-dropdown-item:hover {
        background: rgba(212, 175, 55, 0.1);
      }

      .search-dropdown-item:last-child {
        border-bottom: none;
      }

      .airport-name {
        font-weight: 500;
        color: #fff;
      }

      .airport-code {
        color: #d4af37;
        font-family: monospace;
        font-size: 12px;
      }

      .airport-location {
        font-size: 12px;
        color: #888;
        margin-top: 2px;
      }

      .airport-distance {
        font-size: 11px;
        color: #4ade80;
      }

      .btn-icon {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-small {
        padding: 8px 14px;
        font-size: 12px;
      }

      .filter-tags {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: wrap;
      }

      .filter-tag {
        background: rgba(212, 175, 55, 0.2);
        border: 1px solid #d4af37;
        color: #d4af37;
        padding: 4px 10px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .filter-tag-remove {
        cursor: pointer;
        opacity: 0.7;
        font-weight: bold;
      }

      .filter-tag-remove:hover {
        opacity: 1;
      }

      .no-results {
        text-align: center;
        padding: 20px;
        color: #666;
        font-size: 13px;
      }

      .search-loading {
        padding: 16px;
        text-align: center;
        color: #888;
      }

      .nearby-header {
        padding: 8px 12px;
        background: rgba(212, 175, 55, 0.1);
        font-size: 11px;
        text-transform: uppercase;
        color: #d4af37;
        letter-spacing: 1px;
      }

      /* Trip Type Toggle */
      .toggle-group {
        display: flex;
        gap: 0;
      }

      .toggle-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #888;
        padding: 8px 14px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .toggle-btn:first-child {
        border-right: none;
      }

      .toggle-btn:last-child {
        border-left: none;
      }

      .toggle-btn.active {
        background: rgba(212, 175, 55, 0.2);
        border-color: #d4af37;
        color: #d4af37;
      }

      .toggle-btn:hover:not(.active) {
        background: rgba(255, 255, 255, 0.1);
      }

      .filter-section {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .filter-section-label {
        font-size: 10px;
        text-transform: uppercase;
        color: #888;
        letter-spacing: 1px;
      }

      .sort-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #888;
        padding: 8px 14px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .sort-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .sort-btn.active {
        background: rgba(212, 175, 55, 0.2);
        border-color: #d4af37;
        color: #d4af37;
      }

      .sort-icon {
        font-size: 14px;
      }

      .date-input {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .date-input:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .date-input:focus {
        outline: none;
        border-color: #d4af37;
      }

      .date-input::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
      }

      .radius-select {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        padding: 6px 8px;
        font-size: 11px;
        cursor: pointer;
        margin-top: 6px;
        width: 100%;
      }

      .radius-select:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .radius-select:focus {
        outline: none;
        border-color: #d4af37;
      }

      .radius-select option {
        background: #1a1a1a;
        color: #fff;
      }

      .search-group {
        display: flex;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>PexJet ‚Äî InstaCharter Empty Legs</h1>
      <p>Live empty leg deals from InstaCharter API</p>
    </div>

    <!-- Search & Filter Panel -->
    <div class="search-filter-panel">
      <div class="search-row">
        <div class="search-group">
          <label class="search-label">From (Departure)</label>
          <div class="search-input-wrapper">
            <input
              type="text"
              class="search-input"
              id="fromInput"
              placeholder="Search city, airport, ICAO..."
              autocomplete="off"
              oninput="searchAirports('from', this.value)"
              onfocus="showDropdown('from')"
            />
            <div class="search-dropdown" id="fromDropdown"></div>
          </div>
          <select
            class="radius-select"
            id="fromRadius"
            onchange="onFilterChange()"
          >
            <option value="0">Exact</option>
            <option value="100">100 mi</option>
            <option value="200" selected>200 mi</option>
            <option value="500">500 mi</option>
            <option value="1000">1000 mi</option>
          </select>
        </div>

        <div class="search-group">
          <label class="search-label">To (Arrival)</label>
          <div class="search-input-wrapper">
            <input
              type="text"
              class="search-input"
              id="toInput"
              placeholder="Search city, airport, ICAO..."
              autocomplete="off"
              oninput="searchAirports('to', this.value)"
              onfocus="showDropdown('to')"
            />
            <div class="search-dropdown" id="toDropdown"></div>
          </div>
          <select
            class="radius-select"
            id="toRadius"
            onchange="onFilterChange()"
          >
            <option value="0">Exact</option>
            <option value="100">100 mi</option>
            <option value="200" selected>200 mi</option>
            <option value="500">500 mi</option>
            <option value="1000">1000 mi</option>
          </select>
        </div>

        <button
          class="btn btn-secondary btn-small btn-icon"
          onclick="useMyLocation()"
        >
          üìç Nearby
        </button>

        <div class="filter-section">
          <span class="filter-section-label">From:</span>
          <input
            type="date"
            class="date-input"
            id="dateFrom"
            onchange="onDateFilterChange()"
          />
        </div>

        <div class="filter-section">
          <span class="filter-section-label">To:</span>
          <input
            type="date"
            class="date-input"
            id="dateTo"
            onchange="onDateFilterChange()"
          />
        </div>

        <div class="filter-section">
          <span class="filter-section-label">Sort:</span>
          <button class="sort-btn active" id="sortBtn" onclick="toggleSort()">
            <span>Date</span>
            <span class="sort-icon" id="sortIcon">‚Üë</span>
          </button>
        </div>

        <button class="btn btn-small" onclick="applyFilters()">
          üîç Search
        </button>

        <button class="btn btn-secondary btn-small" onclick="clearFilters()">
          Clear
        </button>
      </div>

      <div class="filter-tags" id="filterTags"></div>
    </div>

    <div class="status-bar">
      <span id="statusText">Ready to fetch deals</span>
      <div class="page-info">
        <span id="pageInfo">Page 1</span>
      </div>
    </div>

    <div class="container">
      <div class="deals-panel">
        <div class="controls">
          <button class="btn" id="fetchBtn" onclick="fetchDeals()">
            Fetch Empty Legs
          </button>
          <button
            class="btn btn-secondary"
            id="prevBtn"
            onclick="prevPage()"
            disabled
          >
            ‚Üê Previous
          </button>
          <button
            class="btn btn-secondary"
            id="nextBtn"
            onclick="nextPage()"
            disabled
          >
            Next ‚Üí
          </button>
        </div>
        <div class="deals-grid" id="dealsGrid">
          <div class="detail-empty" style="grid-column: 1/-1; padding: 60px">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
            <p>Click "Fetch Empty Legs" to load deals</p>
          </div>
        </div>
      </div>

      <div class="detail-panel" id="detailPanel">
        <div class="detail-empty">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
            />
          </svg>
          <p>Select a deal to view details<br />and aircraft image</p>
        </div>
      </div>
    </div>

    <div class="loading-overlay hidden" id="loadingOverlay">
      <div class="spinner"></div>
    </div>

    <script>
      const API_KEY = "92bbb93d-9051-42d7-9c3c-0dd78b18b0e8";
      const BASE_URL = "https://server.instacharter.app";

      let currentPage = 1;
      let deals = [];
      let allDeals = [];
      let selectedDeal = null;
      let aircraftImageCache = {};

      // Filter state
      let filters = {
        from: null,
        to: null,
      };

      let tripTypeFilter = "one way"; // Always One Way only
      let sortOrder = "asc"; // 'asc' or 'desc'
      let dateFilter = { from: null, to: null };
      let radiusFilter = { from: 200, to: 200 }; // Default 200 miles
      let searchTimeout = null;

      // Calculate distance in miles between two coordinates
      function calculateDistanceMiles(lat1, lon1, lat2, lon2) {
        const R = 3959; // Earth's radius in miles
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function onFilterChange() {
        // Update radius filters (no auto-fetch, wait for Search click)
        radiusFilter.from =
          parseInt(document.getElementById("fromRadius").value) || 0;
        radiusFilter.to =
          parseInt(document.getElementById("toRadius").value) || 0;
        renderFilterTags();
      }

      function onDateFilterChange() {
        const fromDate = document.getElementById("dateFrom").value;
        const toDate = document.getElementById("dateTo").value;

        dateFilter.from = fromDate ? new Date(fromDate) : null;
        dateFilter.to = toDate ? new Date(toDate + "T23:59:59") : null;

        renderFilterTags();
        // No auto-fetch, wait for Search click
      }

      function toggleSort() {
        sortOrder = sortOrder === "asc" ? "desc" : "asc";
        document.getElementById("sortIcon").textContent =
          sortOrder === "asc" ? "‚Üë" : "‚Üì";
        // No auto-apply, wait for Search click
      }

      function sortDeals() {
        deals.sort((a, b) => {
          const dateA = new Date(a.from?.dateFrom || 0);
          const dateB = new Date(b.from?.dateFrom || 0);
          return sortOrder === "asc" ? dateA - dateB : dateB - dateA;
        });
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".search-group")) {
          document
            .querySelectorAll(".search-dropdown")
            .forEach((d) => d.classList.remove("active"));
        }
      });

      function showDropdown(type) {
        const dropdown = document.getElementById(`${type}Dropdown`);
        if (dropdown.innerHTML.trim()) {
          dropdown.classList.add("active");
        }
      }

      async function searchAirports(type, query) {
        const dropdown = document.getElementById(`${type}Dropdown`);

        if (query.length < 2) {
          dropdown.classList.remove("active");
          dropdown.innerHTML = "";
          return;
        }

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
          dropdown.innerHTML = '<div class="search-loading">Searching...</div>';
          dropdown.classList.add("active");

          try {
            const response = await fetch(
              `${BASE_URL}/api/Markets/SearchAirportByITA_ICO_NAME_LOCATION?globalInput=${encodeURIComponent(query)}`,
              {
                method: "GET",
                headers: {
                  accept: "application/json",
                  "X-Api-Key": API_KEY,
                },
              },
            );

            const data = await response.json();

            if (data.success && data.data?.length > 0) {
              dropdown.innerHTML = data.data
                .slice(0, 10)
                .map(
                  (airport) => `
                      <div class="search-dropdown-item" onclick="selectAirport('${type}', ${JSON.stringify(airport).replace(/"/g, "&quot;")})">
                        <div>
                          <span class="airport-name">${airport.airportName || airport.name}</span>
                          <span class="airport-code">${airport.icao} / ${airport.iata}</span>
                        </div>
                        <div class="airport-location">${airport.city}, ${airport.country}</div>
                      </div>
                    `,
                )
                .join("");
            } else {
              dropdown.innerHTML =
                '<div class="no-results">No airports found</div>';
            }
          } catch (error) {
            console.error("Airport search error:", error);
            dropdown.innerHTML = '<div class="no-results">Search failed</div>';
          }
        }, 300);
      }

      async function useMyLocation() {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser");
          return;
        }

        updateStatus("Getting your location...");

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const { latitude, longitude } = position.coords;
            await searchNearbyAirports(latitude, longitude);
          },
          (error) => {
            console.error("Geolocation error:", error);
            alert("Could not get your location. Please search manually.");
            updateStatus("Location access denied");
          },
        );
      }

      async function searchNearbyAirports(lat, long) {
        const dropdown = document.getElementById("fromDropdown");
        dropdown.innerHTML =
          '<div class="search-loading">Finding nearby airports...</div>';
        dropdown.classList.add("active");

        try {
          const response = await fetch(
            `${BASE_URL}/api/Markets/SearchNearByAirports?latitude=${lat}&longitude=${long}`,
            {
              method: "GET",
              headers: {
                accept: "application/json",
                "X-Api-Key": API_KEY,
              },
            },
          );

          const data = await response.json();

          if (data.success && data.data?.length > 0) {
            dropdown.innerHTML = `
                    <div class="nearby-header">üìç Nearby Airports</div>
                    ${data.data
                      .slice(0, 8)
                      .map(
                        (airport) => `
                      <div class="search-dropdown-item" onclick="selectAirport('from', ${JSON.stringify(airport).replace(/"/g, "&quot;")})">
                        <div>
                          <span class="airport-name">${airport.name}</span>
                          <span class="airport-code">${airport.icao} / ${airport.iata}</span>
                        </div>
                        <div class="airport-location">
                          ${airport.city}, ${airport.country}
                          <span class="airport-distance">${airport.distance_km?.toFixed(1)} km away</span>
                        </div>
                      </div>
                    `,
                      )
                      .join("")}
                  `;
            updateStatus(`Found ${data.data.length} nearby airports`);
          } else {
            dropdown.innerHTML =
              '<div class="no-results">No nearby airports found</div>';
          }
        } catch (error) {
          console.error("Nearby airports error:", error);
          dropdown.innerHTML = '<div class="no-results">Search failed</div>';
        }
      }

      function selectAirport(type, airport) {
        // Parse if string
        if (typeof airport === "string") {
          airport = JSON.parse(airport);
        }

        const input = document.getElementById(`${type}Input`);
        const dropdown = document.getElementById(`${type}Dropdown`);

        // Handle different API response formats
        const displayName = airport.airportName || airport.name;
        const icao = airport.icao;
        const city = airport.city;

        input.value = `${displayName} (${icao})`;
        dropdown.classList.remove("active");

        filters[type] = {
          icao: icao,
          city: city,
          name: displayName,
          lat: airport.lat,
          long: airport.long,
        };

        // Update radius from dropdown
        radiusFilter[type] =
          parseInt(document.getElementById(`${type}Radius`).value) || 0;

        renderFilterTags();
      }

      function renderFilterTags() {
        const container = document.getElementById("filterTags");
        let html = "";

        if (filters.from) {
          const radiusText =
            radiusFilter.from === 0 ? "exact" : `${radiusFilter.from} mi`;
          html += `
                  <div class="filter-tag">
                    From: ${filters.from.city} (${filters.from.icao}) ‚Ä¢ ${radiusText}
                    <span class="filter-tag-remove" onclick="removeFilter('from')">√ó</span>
                  </div>
                `;
        }

        if (filters.to) {
          const radiusText =
            radiusFilter.to === 0 ? "exact" : `${radiusFilter.to} mi`;
          html += `
                  <div class="filter-tag">
                    To: ${filters.to.city} (${filters.to.icao}) ‚Ä¢ ${radiusText}
                    <span class="filter-tag-remove" onclick="removeFilter('to')">√ó</span>
                  </div>
                `;
        }

        if (dateFilter.from || dateFilter.to) {
          const fromText = dateFilter.from
            ? dateFilter.from.toLocaleDateString()
            : "any";
          const toText = dateFilter.to
            ? dateFilter.to.toLocaleDateString()
            : "any";
          html += `
                  <div class="filter-tag">
                    Date: ${fromText} - ${toText}
                  </div>
                `;
        }

        container.innerHTML = html;
      }

      function removeFilter(type) {
        filters[type] = null;
        document.getElementById(`${type}Input`).value = "";
        renderFilterTags();
        // No auto-fetch, wait for Search click
      }

      function applyFilters() {
        // Update radius values before searching
        radiusFilter.from =
          parseInt(document.getElementById("fromRadius").value) || 0;
        radiusFilter.to =
          parseInt(document.getElementById("toRadius").value) || 0;

        // Fetch deals with all current filters applied
        currentPage = 1;
        fetchDeals();
      }

      function applyFiltersToDeals() {
        let filtered = [...allDeals];

        // Apply date range filter
        if (dateFilter.from) {
          filtered = filtered.filter((deal) => {
            const dealDate = new Date(deal.from?.dateFrom);
            return dealDate >= dateFilter.from;
          });
        }

        if (dateFilter.to) {
          filtered = filtered.filter((deal) => {
            const dealDate = new Date(deal.from?.dateFrom);
            return dealDate <= dateFilter.to;
          });
        }

        // Apply airport filters
        if (filters.from) {
          filtered = filtered.filter((deal) => {
            const dealIcao = deal.from?.fromIcao?.toUpperCase();
            const dealCity = deal.from?.fromCity?.toLowerCase();
            const filterIcao = filters.from.icao?.toUpperCase();
            const filterCity = filters.from.city?.toLowerCase();

            return (
              dealIcao === filterIcao ||
              dealCity?.includes(filterCity) ||
              filterCity?.includes(dealCity?.split(" ")[0] || "")
            );
          });
        }

        if (filters.to) {
          filtered = filtered.filter((deal) => {
            const dealIcao = deal.to?.toIcao?.toUpperCase();
            const dealCity = deal.to?.toCity?.toLowerCase();
            const filterIcao = filters.to.icao?.toUpperCase();
            const filterCity = filters.to.city?.toLowerCase();

            return (
              dealIcao === filterIcao ||
              dealCity?.includes(filterCity) ||
              filterCity?.includes(dealCity?.split(" ")[0] || "")
            );
          });
        }

        deals = filtered;
        sortDeals();
        renderDeals();

        const sortLabel = sortOrder === "asc" ? "oldest first" : "newest first";
        updateStatus(`Showing ${filtered.length} One Way deals (${sortLabel})`);
      }

      function clearFilters() {
        filters = { from: null, to: null };
        dateFilter = { from: null, to: null };
        radiusFilter = { from: 200, to: 200 };
        sortOrder = "asc";
        currentPage = 1;

        document.getElementById("fromInput").value = "";
        document.getElementById("toInput").value = "";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        document.getElementById("fromRadius").value = "200";
        document.getElementById("toRadius").value = "200";
        document.getElementById("sortIcon").textContent = "‚Üë";
        renderFilterTags();

        // Clear results and show empty state
        deals = [];
        allDeals = [];
        document.getElementById("dealsGrid").innerHTML = `
          <div class="detail-empty" style="grid-column: 1/-1; padding: 60px">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
            <p>Set your filters and click "Search" to find deals</p>
          </div>
        `;
        updateStatus("Filters cleared. Click Search to find deals.");
      }

      // Calculate distance between two points using Haversine formula
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in km
      }

      // Estimate flight time based on distance and aircraft category
      function estimateFlightTime(distanceKm, category) {
        // Average cruise speeds by category (km/h)
        const speeds = {
          light: 650,
          midsize: 750,
          "super midsize": 800,
          heavy: 850,
          "ultra long range": 900,
          propeller: 450,
          turboprop: 500,
          helicopter: 250,
        };

        const speed = speeds[category?.toLowerCase()] || 750; // Default to midsize speed
        const flightHours = distanceKm / speed;
        // Add 30 min buffer (takeoff/landing/taxi)
        const totalMinutes = flightHours * 60 + 30;
        // Round up to nearest 5 minutes
        const roundedMinutes = Math.ceil(totalMinutes / 5) * 5;
        return roundedMinutes / 60; // Return in hours
      }

      // Calculate estimated arrival datetime
      function calculateEstimatedArrival(deal) {
        if (!deal.from?.lat || !deal.to?.lat) return null;

        const distanceKm = calculateDistance(
          deal.from.lat,
          deal.from.long,
          deal.to.lat,
          deal.to.long,
        );

        const flightHours = estimateFlightTime(
          distanceKm,
          deal.aircraft?.aircraft_Category,
        );

        const departure = new Date(deal.from.dateFrom);
        const arrival = new Date(
          departure.getTime() + flightHours * 60 * 60 * 1000,
        );

        return {
          arrival: arrival,
          flightTime: flightHours,
          distance: distanceKm,
        };
      }

      function formatFlightTime(hours) {
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        return `${h}h ${m}m`;
      }

      function showLoading() {
        document.getElementById("loadingOverlay").classList.remove("hidden");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.add("hidden");
      }

      function updateStatus(text) {
        document.getElementById("statusText").textContent = text;
      }

      const DEALS_PER_PAGE = 20;
      const MAX_API_PAGES = 20; // Limit to prevent infinite fetching
      let apiPage = 1;
      let hasMoreDeals = true;

      async function fetchDeals() {
        showLoading();
        updateStatus("Fetching empty legs...");

        allDeals = [];
        apiPage = 1;
        hasMoreDeals = true;

        try {
          // Keep fetching until we have enough deals or hit max pages
          while (
            allDeals.length < DEALS_PER_PAGE &&
            hasMoreDeals &&
            apiPage <= MAX_API_PAGES
          ) {
            updateStatus(`Fetching page ${apiPage}...`);

            const response = await fetch(
              `${BASE_URL}/api/Markets/GetAvailabilities?PageNo=${apiPage}`,
              {
                method: "GET",
                headers: {
                  accept: "application/json",
                  "X-Api-Key": API_KEY,
                },
              },
            );

            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
              // Filter by trip type (One Way only)
              let filtered = data.data.filter(
                (deal) =>
                  deal.aircraft?.availabilityType?.toLowerCase() === "one way",
              );

              // Apply date range filter
              if (dateFilter.from) {
                filtered = filtered.filter((deal) => {
                  const dealDate = new Date(deal.from?.dateFrom);
                  return dealDate >= dateFilter.from;
                });
              }
              if (dateFilter.to) {
                filtered = filtered.filter((deal) => {
                  const dealDate = new Date(deal.from?.dateFrom);
                  return dealDate <= dateFilter.to;
                });
              }

              // Apply departure location radius filter
              if (filters.from && filters.from.lat && filters.from.long) {
                filtered = filtered.filter((deal) => {
                  if (!deal.from?.lat || !deal.from?.long) return false;
                  if (radiusFilter.from === 0) {
                    return (
                      deal.from?.fromIcao?.toUpperCase() ===
                      filters.from.icao?.toUpperCase()
                    );
                  }
                  const distance = calculateDistanceMiles(
                    filters.from.lat,
                    filters.from.long,
                    deal.from.lat,
                    deal.from.long,
                  );
                  return distance <= radiusFilter.from;
                });
              }

              // Apply arrival location radius filter
              if (filters.to && filters.to.lat && filters.to.long) {
                filtered = filtered.filter((deal) => {
                  if (!deal.to?.lat || !deal.to?.long) return false;
                  if (radiusFilter.to === 0) {
                    return (
                      deal.to?.toIcao?.toUpperCase() ===
                      filters.to.icao?.toUpperCase()
                    );
                  }
                  const distance = calculateDistanceMiles(
                    filters.to.lat,
                    filters.to.long,
                    deal.to.lat,
                    deal.to.long,
                  );
                  return distance <= radiusFilter.to;
                });
              }

              allDeals = [...allDeals, ...filtered];

              // Check if API has more pages
              if (data.data.length < 20) {
                hasMoreDeals = false;
              }
              apiPage++;
            } else {
              hasMoreDeals = false;
            }
          }

          // Trim to exactly DEALS_PER_PAGE if we got more
          if (allDeals.length > DEALS_PER_PAGE) {
            allDeals = allDeals.slice(0, DEALS_PER_PAGE);
          }

          deals = [...allDeals];
          sortDeals();
          renderDeals();

          document.getElementById("pageInfo").textContent =
            `Page ${currentPage}`;
          document.getElementById("prevBtn").disabled = currentPage === 1;
          document.getElementById("nextBtn").disabled =
            !hasMoreDeals && allDeals.length < DEALS_PER_PAGE;

          const typeLabel =
            tripTypeFilter === "all" ? "" : ` ‚Ä¢ ${tripTypeFilter}`;
          const sortLabel =
            sortOrder === "asc" ? "oldest first" : "newest first";
          updateStatus(
            `Showing ${deals.length} deals${typeLabel} (${sortLabel})`,
          );
        } catch (error) {
          console.error("Error fetching deals:", error);
          updateStatus("Error: " + error.message);
        }

        hideLoading();
      }

      function renderDeals() {
        const grid = document.getElementById("dealsGrid");

        if (deals.length === 0) {
          grid.innerHTML = `
                          <div class="detail-empty" style="grid-column: 1/-1; padding: 60px;">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                              </svg>
                              <p>No deals found matching your filters</p>
                              <p style="font-size: 12px; color: #666;">Try expanding the radius or adjusting date range</p>
                          </div>
                      `;
          return;
        }

        grid.innerHTML = deals
          .map(
            (deal, index) => `
                      <div class="deal-card ${selectedDeal?.id === deal.id ? "selected" : ""}" onclick="selectDeal(${index})">
                          <div class="deal-route">
                              <div class="deal-city">
                                  <div class="deal-city-name">${deal.from?.fromCity || "Unknown"}</div>
                                  <div class="deal-icao">${deal.from?.fromIcao || "----"}</div>
                              </div>
                              <div class="deal-arrow">‚Üí</div>
                              <div class="deal-city" style="text-align: right;">
                                  <div class="deal-city-name">${deal.to?.toCity || "Unknown"}</div>
                                  <div class="deal-icao">${deal.to?.toIcao || "----"}</div>
                              </div>
                          </div>
                          <div class="deal-info">
                              <div class="deal-info-item">
                                  <span class="deal-info-label">Aircraft</span>
                                  <span class="deal-info-value">${deal.aircraft?.aircraft_Type || "N/A"}</span>
                              </div>
                              <div class="deal-info-item">
                                  <span class="deal-info-label">Category</span>
                                  <span class="deal-info-value">${deal.aircraft?.aircraft_Category || "N/A"}</span>
                              </div>
                              <div class="deal-info-item">
                                  <span class="deal-info-label">Date</span>
                                  <span class="deal-info-value">${formatDate(deal.from?.dateFrom)}</span>
                              </div>
                              <div class="deal-info-item">
                                  <span class="deal-info-label">Price</span>
                                  <span class="deal-info-value deal-price">${deal.aircraft?.price || "Contact"}</span>
                              </div>
                          </div>
                      </div>
                  `,
          )
          .join("");
      }

      async function selectDeal(index) {
        selectedDeal = deals[index];
        renderDeals();
        renderDetail();

        // Fetch aircraft image
        await fetchAircraftImage(selectedDeal);
      }

      function renderDetail() {
        const panel = document.getElementById("detailPanel");

        if (!selectedDeal) {
          panel.innerHTML = `
                          <div class="detail-empty">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                              </svg>
                              <p>Select a deal to view details<br>and aircraft image</p>
                          </div>
                      `;
          return;
        }

        const d = selectedDeal;
        const flightInfo = calculateEstimatedArrival(d);
        const arrivalDisplay = flightInfo
          ? formatDateTime(flightInfo.arrival)
          : "N/A";
        const flightTimeDisplay = flightInfo
          ? formatFlightTime(flightInfo.flightTime)
          : "N/A";
        const distanceDisplay = flightInfo
          ? `${Math.round(flightInfo.distance).toLocaleString()} km`
          : "N/A";

        panel.innerHTML = `
                      <div class="detail-header">
                          <h2>${d.aircraft?.aircraft_Type || "Unknown Aircraft"}</h2>
                          <p>${d.aircraft?.aircraft_Category || ""} ‚Ä¢ ${d.aircraft?.availabilityType || "Empty Leg"}</p>
                      </div>

                      <div class="aircraft-image-container" id="aircraftImageContainer">
                          <div class="loading">Loading aircraft image...</div>
                      </div>

                      <div class="detail-section">
                          <div class="detail-section-title">Route</div>
                          <div class="detail-route">
                              <div class="detail-route-city">
                                  <div class="detail-route-city-name">${d.from?.fromCity || "Unknown"}</div>
                                  <div class="detail-route-icao">${d.from?.fromIcao || "----"}</div>
                                  <div class="detail-route-date">Dep: ${formatDateTime(d.from?.dateFrom)}</div>
                              </div>
                              <div class="deal-arrow" style="font-size: 24px;">‚úà</div>
                              <div class="detail-route-city">
                                  <div class="detail-route-city-name">${d.to?.toCity || "Unknown"}</div>
                                  <div class="detail-route-icao">${d.to?.toIcao || "----"}</div>
                                  <div class="detail-route-date">Est. Arr: ${arrivalDisplay}</div>
                              </div>
                          </div>
                      </div>

                      <div class="detail-section">
                          <div class="detail-section-title">Flight Details</div>
                          <div class="detail-specs">
                              <div class="detail-spec">
                                  <div class="detail-spec-label">Est. Flight Time</div>
                                  <div class="detail-spec-value">${flightTimeDisplay}</div>
                              </div>
                              <div class="detail-spec">
                                  <div class="detail-spec-label">Distance</div>
                                  <div class="detail-spec-value">${distanceDisplay}</div>
                              </div>
                              <div class="detail-spec">
                                  <div class="detail-spec-label">Seats</div>
                                  <div class="detail-spec-value">${d.aircraft?.seats || "N/A"}</div>
                              </div>
                              <div class="detail-spec">
                                  <div class="detail-spec-label">Price</div>
                                  <div class="detail-spec-value price">${d.aircraft?.price || "Contact"}</div>
                              </div>
                          </div>
                      </div>

                      <div class="detail-section">
                          <div class="detail-section-title">Operator</div>
                          <div class="operator-info">
                              <div class="operator-name">${d.companyDetails?.companyName || "Unknown Operator"}</div>
                              <div class="operator-contact">
                                  ${d.companyDetails?.email ? `üìß ${d.companyDetails.email}<br>` : ""}
                                  ${d.companyDetails?.phone ? `üìû ${d.companyDetails.phone}` : ""}
                              </div>
                          </div>
                      </div>
                  `;
      }

      async function fetchAircraftImage(deal) {
        const container = document.getElementById("aircraftImageContainer");
        if (!container) return;

        const aircraftType = deal.aircraft?.aircraft_Type;

        // Check cache first
        if (aircraftImageCache[aircraftType]) {
          container.innerHTML = `<img src="${aircraftImageCache[aircraftType]}" alt="${aircraftType}">`;
          return;
        }

        container.innerHTML =
          '<div class="loading">Fetching aircraft image...</div>';

        try {
          // Use GetOptions to find aircraft image
          const response = await fetch(`${BASE_URL}/api/Markets/GetOptions`, {
            method: "POST",
            headers: {
              accept: "application/json",
              "X-Api-Key": API_KEY,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              currency: "USD",
              clientId: API_KEY,
              itinerary: [
                {
                  from: {
                    lat: deal.from?.lat || 0,
                    long: deal.from?.long || 0,
                    name: deal.from?.fromCity || "Origin",
                  },
                  to: {
                    lat: deal.to?.lat || 0,
                    long: deal.to?.long || 0,
                    name: deal.to?.toCity || "Destination",
                  },
                  date:
                    deal.from?.dateFrom?.split("T")[0] ||
                    new Date().toISOString().split("T")[0],
                  pax: deal.aircraft?.seats || 4,
                },
              ],
            }),
          });

          const data = await response.json();

          if (data.success && data.data?.base) {
            // Find matching aircraft type or use first available image
            let imageUrl = null;

            for (const category of data.data.base) {
              if (category.aircraftDetails) {
                // Try to find exact match first
                const exactMatch = category.aircraftDetails.find(
                  (a) =>
                    a.aircraftName?.toLowerCase() ===
                    aircraftType?.toLowerCase(),
                );

                if (exactMatch?.image) {
                  imageUrl = exactMatch.image;
                  break;
                }

                // Try partial match
                const partialMatch = category.aircraftDetails.find((a) =>
                  aircraftType
                    ?.toLowerCase()
                    .includes(a.aircraftName?.toLowerCase().split(" ")[0]),
                );

                if (partialMatch?.image) {
                  imageUrl = partialMatch.image;
                  break;
                }

                // Use category match
                if (
                  category.aircraftCategory?.toLowerCase() ===
                  deal.aircraft?.aircraft_Category?.toLowerCase()
                ) {
                  imageUrl = category.aircraftDetails[0]?.image;
                  break;
                }
              }
            }

            // Fallback to first available image
            if (!imageUrl && data.data.base[0]?.aircraftDetails?.[0]?.image) {
              imageUrl = data.data.base[0].aircraftDetails[0].image;
            }

            if (imageUrl) {
              aircraftImageCache[aircraftType] = imageUrl;
              container.innerHTML = `<img src="${imageUrl}" alt="${aircraftType}">`;
            } else {
              container.innerHTML =
                '<div class="no-image">No image available for this aircraft</div>';
            }
          } else {
            container.innerHTML =
              '<div class="no-image">Could not fetch aircraft image</div>';
          }
        } catch (error) {
          console.error("Error fetching aircraft image:", error);
          container.innerHTML =
            '<div class="no-image">Error loading image</div>';
        }
      }

      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      function formatDateTime(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Track the last API page we fetched from for pagination
      let lastApiPage = 1;

      function prevPage() {
        if (currentPage > 1) {
          currentPage--;
          // For previous, we need to re-fetch from beginning up to that page
          fetchDealsForPage(currentPage);
        }
      }

      function nextPage() {
        currentPage++;
        fetchDealsForPage(currentPage);
      }

      async function fetchDealsForPage(targetPage) {
        showLoading();
        updateStatus("Fetching empty legs...");

        allDeals = [];
        let localApiPage = 1;
        let localHasMore = true;
        const targetCount = targetPage * DEALS_PER_PAGE;
        const maxPages = MAX_API_PAGES * targetPage; // Scale max pages with target

        try {
          // Fetch enough deals to fill up to the target page (with max limit)
          while (
            allDeals.length < targetCount &&
            localHasMore &&
            localApiPage <= maxPages
          ) {
            updateStatus(`Fetching page ${localApiPage}...`);

            const response = await fetch(
              `${BASE_URL}/api/Markets/GetAvailabilities?PageNo=${localApiPage}`,
              {
                method: "GET",
                headers: {
                  accept: "application/json",
                  "X-Api-Key": API_KEY,
                },
              },
            );

            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
              // Filter by trip type (One Way only)
              let filtered = data.data.filter(
                (deal) =>
                  deal.aircraft?.availabilityType?.toLowerCase() === "one way",
              );

              // Apply date range filter
              if (dateFilter.from) {
                filtered = filtered.filter((deal) => {
                  const dealDate = new Date(deal.from?.dateFrom);
                  return dealDate >= dateFilter.from;
                });
              }
              if (dateFilter.to) {
                filtered = filtered.filter((deal) => {
                  const dealDate = new Date(deal.from?.dateFrom);
                  return dealDate <= dateFilter.to;
                });
              }

              // Apply departure location radius filter
              if (filters.from && filters.from.lat && filters.from.long) {
                filtered = filtered.filter((deal) => {
                  if (!deal.from?.lat || !deal.from?.long) return false;
                  if (radiusFilter.from === 0) {
                    return (
                      deal.from?.fromIcao?.toUpperCase() ===
                      filters.from.icao?.toUpperCase()
                    );
                  }
                  const distance = calculateDistanceMiles(
                    filters.from.lat,
                    filters.from.long,
                    deal.from.lat,
                    deal.from.long,
                  );
                  return distance <= radiusFilter.from;
                });
              }

              // Apply arrival location radius filter
              if (filters.to && filters.to.lat && filters.to.long) {
                filtered = filtered.filter((deal) => {
                  if (!deal.to?.lat || !deal.to?.long) return false;
                  if (radiusFilter.to === 0) {
                    return (
                      deal.to?.toIcao?.toUpperCase() ===
                      filters.to.icao?.toUpperCase()
                    );
                  }
                  const distance = calculateDistanceMiles(
                    filters.to.lat,
                    filters.to.long,
                    deal.to.lat,
                    deal.to.long,
                  );
                  return distance <= radiusFilter.to;
                });
              }

              allDeals = [...allDeals, ...filtered];

              if (data.data.length < 20) {
                localHasMore = false;
              }
              localApiPage++;
            } else {
              localHasMore = false;
            }
          }

          lastApiPage = localApiPage;
          hasMoreDeals = localHasMore || allDeals.length >= targetCount;

          // Get only the deals for the current page
          const startIndex = (targetPage - 1) * DEALS_PER_PAGE;
          const endIndex = startIndex + DEALS_PER_PAGE;
          deals = allDeals.slice(startIndex, endIndex);

          sortDeals();
          renderDeals();

          document.getElementById("pageInfo").textContent =
            `Page ${currentPage}`;
          document.getElementById("prevBtn").disabled = currentPage === 1;
          document.getElementById("nextBtn").disabled =
            deals.length < DEALS_PER_PAGE && !localHasMore;

          const sortLabel =
            sortOrder === "asc" ? "oldest first" : "newest first";
          updateStatus(`Showing ${deals.length} One Way deals (${sortLabel})`);
        } catch (error) {
          console.error("Error fetching deals:", error);
          updateStatus("Error: " + error.message);
        }

        hideLoading();
      }
    </script>
  </body>
</html>
