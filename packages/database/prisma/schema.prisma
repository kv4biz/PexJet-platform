generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Country {
  id            String    @id @default(cuid())
  code          String    @unique
  name          String
  continent     String
  wikipediaLink String?
  keywords      String?
  createdAt     DateTime  @default(now())
  airports      Airport[]
  regions       Region[]
}

model Region {
  id            String    @id @default(cuid())
  code          String    @unique
  localCode     String
  name          String
  continent     String
  countryCode   String
  wikipediaLink String?
  keywords      String?
  createdAt     DateTime  @default(now())
  airports      Airport[]
  country       Country   @relation(fields: [countryCode], references: [code])

  @@index([countryCode])
}

model Airport {
  id                 String       @id @default(cuid())
  ident              String       @unique
  type               AirportType
  name               String
  latitude           Float
  longitude          Float
  elevationFt        Int?
  continent          String
  countryCode        String
  regionCode         String
  municipality       String?
  scheduledService   Boolean      @default(false)
  icaoCode           String?
  iataCode           String?
  gpsCode            String?
  localCode          String?
  homeLink           String?
  wikipediaLink      String?
  keywords           String?
  createdAt          DateTime     @default(now())
  country            Country      @relation(fields: [countryCode], references: [code])
  region             Region       @relation(fields: [regionCode], references: [code])
  arrivals           CharterLeg[] @relation("ArrivalAirport")
  departures         CharterLeg[] @relation("DepartureAirport")
  emptyLegArrivals   EmptyLeg[]   @relation("EmptyLegArrival")
  emptyLegDepartures EmptyLeg[]   @relation("EmptyLegDeparture")

  @@index([countryCode])
  @@index([regionCode])
  @@index([icaoCode])
  @@index([iataCode])
  @@index([name])
  @@index([municipality])
}

model Aircraft {
  id                   String                 @id @default(cuid())
  name                 String
  manufacturer         String
  category             AircraftCategory
  availability         AircraftAvailability   @default(NONE)
  basePricePerHour     Float?                 // Base price per hour for charter calculations
  cabinLengthFt        Float?
  cabinWidthFt         Float?
  cabinHeightFt        Float?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  baggageCuFt          Float?
  exteriorHeightFt     Float?
  exteriorLengthFt     Float?
  exteriorWingspanFt   Float?
  image                String?
  maxPax               Int?
  minPax               Int?
  cruiseSpeedKnots     Float?
  fuelCapacityGal      Float?
  rangeNm              Float?
  charterLegs          CharterLeg[]
  charterQuoteAircraft CharterQuoteAircraft[]
  emptyLegs            EmptyLeg[]
  operatorFleets       OperatorFleet[]

  @@index([category])
  @@index([availability])
  @@index([manufacturer])
}

model Admin {
  id                       String                @id @default(cuid())
  email                    String                @unique
  username                 String                @unique
  passwordHash             String
  fullName                 String
  phone                    String
  role                     AdminRole             @default(STAFF)
  status                   AdminStatus           @default(OFFLINE)
  avatar                   String?
  address                  String?
  resetOtp                 String?
  resetOtpExpiry           DateTime?
  refreshToken             String?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  activityLogs             ActivityLog[]
  announcements            Announcement[]
  charterQuotesApproved    CharterQuote[]        @relation("ApprovedBy")
  charterPaymentsConfirmed CharterQuote[]        @relation("PaymentConfirmedBy")
  emptyLegsCreated         EmptyLeg[]            @relation("CreatedByAdmin")
  emptyLegBookingsApproved EmptyLegBooking[]     @relation("BookingApprovedBy")
  instaCharterSyncs        InstaCharterSyncLog[]

  @@index([email])
  @@index([username])
}

model Operator {
  id                     String          @id @default(cuid())
  email                  String          @unique
  username               String          @unique
  passwordHash           String
  fullName               String
  phone                  String
  avatar                 String?
  bankName               String
  bankAccountNumber      String
  bankAccountName        String
  paystackSubaccountCode String?
  commissionPercent      Float           @default(10)
  resetOtp               String?
  resetOtpExpiry         DateTime?
  refreshToken           String?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  emptyLegs              EmptyLeg[]      @relation("CreatedByOperator")
  fleet                  OperatorFleet[]

  @@index([email])
  @@index([username])
}

model OperatorFleet {
  id         String   @id @default(cuid())
  operatorId String
  aircraftId String
  createdAt  DateTime @default(now())
  aircraft   Aircraft @relation(fields: [aircraftId], references: [id], onDelete: Cascade)
  operator   Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@unique([operatorId, aircraftId])
  @@index([operatorId])
}

model Client {
  id               String            @id @default(cuid())
  phone            String            @unique
  fullName         String?
  email            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  charterQuotes    CharterQuote[]
  emptyLegBookings EmptyLegBooking[]
  payments         Payment[]

  @@index([phone])
  @@index([email])
}

model CharterQuote {
  id                   String                 @id @default(cuid())
  referenceNumber      String                 @unique
  clientId             String
  clientName           String
  clientEmail          String
  clientPhone          String
  flightType           FlightType
  passengerCount       Int
  specialRequests      String?
  status               QuoteStatus            @default(PENDING)
  rejectionReason      RejectionReason?
  rejectionNote        String?
  approvedById         String?
  approvedAt           DateTime?
  paymentDeadline      DateTime?
  paymentLink          String?
  quoteDocumentUrl     String?
  flightDocumentUrl    String?
  receiptUrl           String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  paymentMethod        PaymentMethod?
  totalPriceUsd        Float?
  confirmationSentAt   DateTime?
  invoiceDocumentUrl   String?
  paymentConfirmedAt   DateTime?
  paymentConfirmedById String?
  receiptUploadedAt    DateTime?
  receiptUploadedUrl   String?
  legs                 CharterLeg[]
  approvedBy           Admin?                 @relation("ApprovedBy", fields: [approvedById], references: [id])
  client               Client                 @relation(fields: [clientId], references: [id])
  paymentConfirmedBy   Admin?                 @relation("PaymentConfirmedBy", fields: [paymentConfirmedById], references: [id])
  selectedAircraft     CharterQuoteAircraft[]
  payment              Payment?

  @@index([clientId])
  @@index([status])
  @@index([referenceNumber])
}

model CharterQuoteAircraft {
  id             String       @id @default(cuid())
  charterQuoteId String
  aircraftId     String
  aircraft       Aircraft     @relation(fields: [aircraftId], references: [id], onDelete: Cascade)
  charterQuote   CharterQuote @relation(fields: [charterQuoteId], references: [id], onDelete: Cascade)

  @@unique([charterQuoteId, aircraftId])
}

model CharterLeg {
  id                 String       @id @default(cuid())
  charterQuoteId     String
  legNumber          Int
  departureAirportId String
  arrivalAirportId   String
  departureDateTime  DateTime
  aircraftId         String?
  additionalNotes    String?
  boardingInfo       String?
  checkInTime        DateTime?
  confirmationSentAt DateTime?
  gateInfo           String?
  pilotContact       String?
  pilotName          String?
  priceUsd           Float?
  terminalInfo       String?
  ticketNumber       String?
  aircraft           Aircraft?    @relation(fields: [aircraftId], references: [id])
  arrivalAirport     Airport      @relation("ArrivalAirport", fields: [arrivalAirportId], references: [id])
  charterQuote       CharterQuote @relation(fields: [charterQuoteId], references: [id], onDelete: Cascade)
  departureAirport   Airport      @relation("DepartureAirport", fields: [departureAirportId], references: [id])

  @@index([charterQuoteId])
  @@index([departureAirportId])
  @@index([arrivalAirportId])
}

model EmptyLeg {
  id                  String            @id @default(cuid())
  slug                String            @unique
  departureAirportId  String?
  arrivalAirportId    String?
  departureDateTime   DateTime
  aircraftId          String?
  totalSeats          Int
  availableSeats      Int
  status              EmptyLegStatus    @default(PUBLISHED)
  createdByAdminId    String?
  createdByOperatorId String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  aircraftCategory    String?
  aircraftImage       String?
  aircraftName        String?
  aircraftType        String?
  arrivalCity         String?
  arrivalCountry      String?
  arrivalIcao         String?
  departureCity       String?
  departureCountry    String?
  departureIcao       String?
  externalId          String?           @unique
  lastSyncedAt        DateTime?
  operatorEmail       String?
  operatorName        String?
  operatorPhone       String?
  operatorCompanyId    Int?
  operatorWebsite     String?
  operatorRating      Decimal?         @db.Decimal(3, 2)
  priceType           EmptyLegPriceType @default(FIXED)
  priceUsd            Float?
  source              EmptyLegSource    @default(ADMIN)
  aircraft            Aircraft?         @relation(fields: [aircraftId], references: [id], onDelete: Cascade)
  arrivalAirport      Airport?          @relation("EmptyLegArrival", fields: [arrivalAirportId], references: [id])
  createdByAdmin      Admin?            @relation("CreatedByAdmin", fields: [createdByAdminId], references: [id])
  createdByOperator   Operator?         @relation("CreatedByOperator", fields: [createdByOperatorId], references: [id])
  departureAirport    Airport?          @relation("EmptyLegDeparture", fields: [departureAirportId], references: [id])
  bookings            EmptyLegBooking[]

  @@index([source])
  @@index([status])
  @@index([departureAirportId])
  @@index([arrivalAirportId])
  @@index([departureDateTime])
  @@index([slug])
  @@index([externalId])
}

model EmptyLegBooking {
  id                  String           @id @default(cuid())
  referenceNumber     String           @unique
  emptyLegId          String
  clientId            String
  clientName          String
  clientEmail         String
  clientPhone         String
  seatsRequested      Int
  status              QuoteStatus      @default(PENDING)
  rejectionReason     RejectionReason?
  rejectionNote       String?
  approvedById        String?
  approvedAt          DateTime?
  paymentDeadline     DateTime?
  paymentLink         String?
  quoteDocumentUrl    String?
  flightDocumentUrl   String?
  receiptUrl          String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  additionalNotes     String?
  boardingInfo        String?
  checkInTime         DateTime?
  confirmationSentAt  DateTime?
  gateInfo            String?
  paymentMethod       PaymentMethod?
  pilotContact        String?
  pilotName           String?
  terminalInfo        String?
  ticketNumber        String?
  totalPriceUsd       Float
  bankAccountName     String?
  bankAccountNumber   String?
  bankName            String?
  bankSortCode        String?
  externalRequestId   String?
  forwardedAt         DateTime?
  forwardedToExternal Boolean          @default(false)
  isReadOnly          Boolean          @default(false)
  source              EmptyLegSource   @default(ADMIN)
  approvedBy          Admin?           @relation("BookingApprovedBy", fields: [approvedById], references: [id])
  client              Client           @relation(fields: [clientId], references: [id])
  emptyLeg            EmptyLeg         @relation(fields: [emptyLegId], references: [id], onDelete: Cascade)
  payment             Payment?

  @@index([emptyLegId])
  @@index([clientId])
  @@index([status])
  @@index([source])
}

model InstaCharterSyncLog {
  id            String    @id @default(cuid())
  syncType      String    @default("SCHEDULED")
  status        String
  dealsFound    Int       @default(0)
  dealsCreated  Int       @default(0)
  dealsUpdated  Int       @default(0)
  dealsRemoved  Int       @default(0)
  errorMessage  String?
  errorDetails  String?
  triggeredById String?
  startedAt     DateTime  @default(now())
  completedAt   DateTime?
  durationMs    Int?
  createdAt     DateTime  @default(now())
  triggeredBy   Admin?    @relation(fields: [triggeredById], references: [id])

  @@index([status])
  @@index([startedAt])
}

model Payment {
  id                    String           @id @default(cuid())
  referenceNumber       String           @unique
  clientId              String
  type                  PaymentType
  charterQuoteId        String?          @unique
  emptyLegBookingId     String?          @unique
  paystackReference     String?          @unique
  paystackAccessCode    String?
  status                PaymentStatus    @default(PENDING)
  paidAt                DateTime?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  adminAmountUsd        Float?
  amountUsd             Float
  bankTransferConfirmed Boolean          @default(false)
  confirmedAt           DateTime?
  confirmedById         String?
  method                PaymentMethod
  operatorAmountUsd     Float?
  charterQuote          CharterQuote?    @relation(fields: [charterQuoteId], references: [id])
  client                Client           @relation(fields: [clientId], references: [id])
  emptyLegBooking       EmptyLegBooking? @relation(fields: [emptyLegBookingId], references: [id])

  @@index([clientId])
  @@index([status])
  @@index([paystackReference])
}

model ActivityLog {
  id          String         @id @default(cuid())
  action      ActivityAction
  description String
  adminId     String?
  operatorId  String?
  clientPhone String?
  targetType  String?
  targetId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  seenBy      String[]       @default([])
  createdAt   DateTime       @default(now())
  admin       Admin?         @relation(fields: [adminId], references: [id])

  @@index([action])
  @@index([adminId])
  @@index([createdAt])
  @@index([targetType, targetId])
}

model Announcement {
  id          String    @id @default(cuid())
  title       String
  message     String
  imageUrl    String?
  createdById String
  sentAt      DateTime?
  createdAt   DateTime  @default(now())
  createdBy   Admin     @relation(fields: [createdById], references: [id])

  @@index([createdAt])
}

model EmptyLegSubscription {
  id        String           @id @default(cuid())
  phone     String
  type      SubscriptionType @default(ALL)
  cities    String[]         @default([])
  routeFrom String?
  routeTo   String?
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([phone])
  @@index([type])
  @@index([isActive])
}

model Settings {
  id                        String   @id @default("default")
  paymentWindowHours        Int      @default(3)
  dealDeadlineMinutes       Int      @default(30)
  minimumBookingNoticeHours Int      @default(24)
  defaultOperatorCommission Float    @default(10)
  cancellationPolicy        String?
  termsAndConditions        String?
  privacyPolicy             String?
  supportEmail              String?
  supportPhone              String?
  quoteCounter              Int      @default(0)
  emptyLegCounter           Int      @default(0)
  receiptCounter            Int      @default(0)
  flightConfirmCounter      Int      @default(0)
  updatedAt                 DateTime @updatedAt
  bankAccountName           String?
  bankAccountNumber         String?
  bankCode                  String?
  bankName                  String?
  companyAddress            String?
  companyEmail              String?
  companyName               String   @default("PexJet")
  companyPhone              String?
  facebookUrl               String?
  instagramUrl              String?
  linkedinUrl               String?
  proofOfPaymentWhatsApp    String?
  twitterUrl                String?
}

model DocumentTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AdminRole {
  SUPER_ADMIN
  STAFF
}

enum AdminStatus {
  ONLINE
  OFFLINE
}

enum AircraftAvailability {
  NONE
  LOCAL
  INTERNATIONAL
  BOTH
}

enum AircraftCategory {
  LIGHT
  MIDSIZE
  SUPER_MIDSIZE
  ULTRA_LONG_RANGE
  HEAVY
}

enum FlightType {
  ONE_WAY
  ROUND_TRIP
  MULTI_LEG
}

enum QuoteStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  PAID
  COMPLETED
}

enum EmptyLegStatus {
  PUBLISHED
  OPEN
  CLOSED
  UNAVAILABLE
}

enum EmptyLegSource {
  ADMIN
  OPERATOR
  INSTACHARTER
}

enum EmptyLegPriceType {
  FIXED
  CONTACT
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  PAYSTACK
  BANK_TRANSFER
}

enum PaymentType {
  CHARTER
  EMPTY_LEG
}

enum SubscriptionType {
  CITY
  ROUTE
  ALL
}

enum RejectionReason {
  AIRCRAFT_UNAVAILABLE
  ROUTE_NOT_SERVICEABLE
  INVALID_DATES
  PRICING_ISSUE
  CAPACITY_EXCEEDED
  DEAL_NOT_AVAILABLE
  NO_PAYMENT_MADE
  OTHER
}

enum ActivityAction {
  ADMIN_CREATE
  ADMIN_UPDATE
  ADMIN_DELETE
  OPERATOR_CREATE
  OPERATOR_UPDATE
  OPERATOR_DELETE
  AIRCRAFT_CREATE
  AIRCRAFT_UPDATE
  AIRCRAFT_DELETE
  CHARTER_QUOTE_CREATE
  CHARTER_QUOTE_APPROVE
  CHARTER_QUOTE_REJECT
  CHARTER_QUOTE_EXPIRE
  EMPTY_LEG_CREATE
  EMPTY_LEG_UPDATE
  EMPTY_LEG_CLOSE
  EMPTY_LEG_QUOTE_CREATE
  EMPTY_LEG_QUOTE_APPROVE
  EMPTY_LEG_QUOTE_REJECT
  PAYMENT_INITIATED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  SETTINGS_UPDATE
  AIRPORT_IMPORT
  ANNOUNCEMENT_CREATE
  ANNOUNCEMENT_DELETE
  SUBSCRIPTION_CREATE
  SUBSCRIPTION_DELETE
  EMPTY_LEG_NOTIFICATION
  CHARTER_QUOTE_UPDATE
  CHARTER_RECEIPT_UPLOADED
  CHARTER_PAYMENT_CONFIRMED
  CHARTER_CONFIRMATION_SENT
  EMPTY_LEG_QUOTE_FORWARDED
  INSTACHARTER_SYNC_START
  INSTACHARTER_SYNC_COMPLETE
  INSTACHARTER_SYNC_ERROR
}

enum AirportType {
  large_airport
  medium_airport
  small_airport
  heliport
  seaplane_base
  closed
  balloonport
}
